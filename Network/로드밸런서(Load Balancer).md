# ***📌*** 로드밸런서(Load Balancer)

# 1. 로드 밸런서 (Load Balancer)

`로드밸런서`란 서버에 가해지는 `부하(= 로드)`를 `분산(=밸런싱)` 해주는 장치 또는 기술을 말한다.  **클라이언트와 서버 사이에 위치하며 한대의 서버로 부하가 집중되지 않도록 트래픽을 관리해 각각의 서버가 최적의 퍼포먼스를 보일 수 있도록한다.**

`scale-up`은 서버 자체의 성능을 확장하는 것을 말하고 `scale-out` 은 기존 서버와 동일하거나 낮은 성능의 서버를 증설하는것을 말한다. 이때 여러대의 서버가 생기기 때문에 트래픽을 균등하게 분산해주는 `로드밸런싱`이 반드시 필요하다.

# 2. 로드 밸런싱 방식

로드밸런싱 기법은 여러가지가 존재한다.

## 2.1 라운드 로빈 방식(Round Robin Method)

서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식이다. 요청을 순서대로 분배하기 때문에 여러대의 서버가 동일한 스펙을 갖고있고, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 활용하기 적합하다. 순서대로 분배해서 평균에 수렴하기때문에 가장 많이 쓰이는 방법이다.

## 2.2 가중 라운드로빈 방식(Weighted Round Robin Method)

각각의 서버마다 가중치를 매기고 가중치를 높은 서버에 클라이언트 요청을 우선적으로 배분한다. 주로 서버의 트래픽 처리 능력이 상이한 경우 사용하는 방식이다.

## 2.3 최소 연결 방식(Least Connection Method)

로드 밸런서는 connection 정보를 갖고있는데 이 정보를 가지고 요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배분한다.

## 2.4 IP 해시 방식(IP Hash Method)

클라이언트의 IP 주소를 특정 서버로 매핑하여 요청을 처리하는 방식이다. 사용자의 IP를 해싱(임의의 크기의 데이터를 고정된  고정된 길이의 해시값으로 변환) 하여 로드를 분산하기 때문에 사용자가 항상 동일한 서버로 연결되는것을 보장한다.

보통 채팅같은 경우 커넥션이 열려있고 데이터가 왔다갔다 하는 양방향 통신이다. 이때 세션을 열어놓고 서버를 지정해서 쓰는 경우가 많다. 이때 지금 어느 서버에 연결되었는지를 표시해두는 일종의 캐시같은 역할을 하는 서버가 필요한데 이 역할을 로드밸런서가 할 수 있다.

## 2.5 최소 리스폰타임 방식(Least Response Time Method)

서버의 현재 연결 상태와 응답시간을 고려해서 트래픽을 배분한다. 가장 적은 연결상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분하는 방식이다.

# 3. 로드 밸런서의 종류

![osi7](https://github.com/princenim/TIL/assets/59499600/6a8be2fe-fbe1-4471-98a7-f0b0b7ad92da)

로드 밸런서는 여러 종류가 있다. 그렇다면 로드밸런서는 `OSI 7 Layer`에 어느 계층에 존재할까? 계층에 따라서  종류가 달라지는데 가장 많이 사용하는 로드밸런서는 `L4`에 있는 로드밸런서, `L7`에 있는 로드밸런서이다. 상위 계층은 하위 계층의 데이터를 다 가지기 때문에 상위 계층일수롣 섬세한 로드밸런싱이 가능하고 하위 계층일수록 간단한 로드 밸런싱이 가능하다.

[OSI 모델과 TCP/IP 모델](https://github.com/princenim/TIL/blob/master/Network/OSI%20%EB%AA%A8%EB%8D%B8%EA%B3%BC%20TCP%2CIP%EB%AA%A8%EB%8D%B8.md#osi-%EB%AA%A8%EB%8D%B8%EA%B3%BC-tcpip-%EB%AA%A8%EB%8D%B8)
## 3.1 L4 로드 밸런서

먼저 4 계층 즉 전송(Transport)계층에서는 데이터의 신뢰성과 흐름 제어를 담당하며 주로 `TCP`,`UDP` 프로토콜이 사용된다.

`L4 로드 밸런서`는 4계층에서 동작하며 4계층 이하의 모든 정보를 갖는다. 즉, `L4 로드밸런서`는 네트워크 계층의 `IP나 포트번호`와 전송계층의 `TCP`,`UDP` 정보를 바탕으로 로드를 분산할 수 있다. `TCP`를 이용해 로드를 분산한다는 말을 더 자세히 설명하면 `TCP 헤더`에는 송신자와 수신자의 `IP 주소, 포트번호, TCP 연결 상태`가있는데 이를 기반으로 `L4 로드 밸런서`는 요청을 다양한 서버로 분배할 수 있다.

## 3.2 L7 로드 밸런서

먼저 7 계층 즉, 응용(Application) 계층은 최종 목적지로 네트워크 서비스를 사용자에게 제공하는 역할을 담당한다. 크롬, 사파리, 웹 브라우저 같은 응용 프로그램이 대표적이다. 이 계층은 사용자 인터페이스 , 파일 전송, 이메일 전송같은 다양한 서비스를 포함한다. 응용 계층에서는 `HTTP`, `FTP`, `SMTP` 와 같은 프로토콜이 사용된다.

`L7 로드 밸런서`는 응용계층에서 동작하며 `HTTP`의 `헤더, 쿠키, URL` 등을 사용해 서버에 트래픽을 분산하는것이 가능한다. 더 쉽게 말하면 패킷의 내용을 확인해 그 내용에 따라 로드를 특정 서버에 분배하는 것이 가능하다. 또한 L7 로드밸런서의 경우 특정한 패턴을 지닌 바이러스를 감지해 네트워크를 보호할 수 있으며 비정상적인 트래픽을 필터링할 수 있다.

예를들어 위의  `최소 리스폰타임 방식(Least Response Time Method)` 같은 경우에는 응답시간과 연결상태가 필요하다. 응답시간의 경우 서버의 입장에서 응답시간을 기록해 `HTTP 응답 헤더`에 `X-Response-Time` 라는 사용자 정의 헤더를 추가한다. 그리고 로드 밸런서는 서버들 간의 `X-Response-Time`이라는 값을 비교해 가장 작은 응답시간을 가진 서버를 선택해 트래픽을 분배한다. 이런 로드밸런싱 방식은 `HTTP 메세지`를 읽을 수 있어야하므로 `L7 로드밸런서`로만 가능하다. 따라서 보통 L7 로드 밸런서가 L4 로드밸런서보다 비싸다.