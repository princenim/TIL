# 📌 데이터베이스 샤딩(Sharding)

# 1. 샤딩(Sharding)

먼저 **`샤딩`이란 대규모 분산 데이터베이스 시스템에서 데이터를 수평으로 분할하여 여러 서버에 분산 저장하는 기술이다.** 이 방법은 데이터베이스의 성능과 확장성을 향상시킨다.

샤딩의 핵심은 `샤드 키(Shard key)`를 어떻게 선택하느냐에 있다. 샤드 키는 데이터를 분할하고 분산 저장하는 기준이 되며, 샤딩의 성능과 효율성을 결정짓는 중요한 요소이다. 하지만 샤딩은 이점이 많은 동시에 고려해야할 부분이 많다. 데이터를 분산 저장함으로써 데이터의 일관성에 문제가 생길 수 있고, 시스템의 성능 저하를 야기할 수 있다.

## 1.1 고려할 부분

**만약 DB 3개가 존재한다. 데이터를 어떻게 나눠서 넣을건가?**

단순히 순서대로 데이터를 처리하는 경우, 데이터베이스 샤딩으로 인해 문제가 발생할 수 있다. 예를 들어, 유저가 글을 작성하고 1번 DB에 저장했다고 가정해보자. 후에  다른 유저가 글을 읽으려고 할 때, 이를 처리할 2번 DB에 요청을 보내면, 1번 DB에 저장된 글이 아닌 다른 데이터가 반환될 수 있다. 이처럼 데이터가 여러 DB에 분산되어 있다면 순서대로 처리하면 문제가발생한다.

**그러면 어떻게 해결할 수 있을까? 가장 흔한 방법이 샤딩키이다.**

유저 id를 샤딩 키로 사용한다고 한다면,  `유저 id % db의 개수`로 나머지를 샤딩키로 사용할 수 있다. 따라서 유저 id가 13일때 DB개 3개이므로 `13 % 3 = 1`을 사딩키로 하여 유저 13이 쓰는 글은 모두 1번 DB에 저장된다. 반면에 유저 id가 14일때 `14%4 = 2`로 유저 14가 쓰는 글은 모두 2번 DB에 저장된다.

그러면 더 나아가 만약 DB가 병목 포인트여서 확장을 해야한다면 어떻게 해야할까?

만약 DB가 8개로 늘어날 거라고 가정하면 유저의 샤딩키가 바뀐다. 그럼 기존에 유저 13이 쓰는 글은 다 1번 DB로 가는데, 늘어난 후에는 2번 DB로 가게되므로 문제가 발생한다. 이때는 1번 DB의 데이터를 모두 2번 DB로 옮겨야하고 이는 라이브 서비스중에 수행하기는 어렵다.

이렇게 샤딩은 매우 어려운 작업이므로 보통 DB를 설계할 때 ‘DB를 몇 개를 사용할 것인가’를 고려하고, 미래에 몇개까지 쓸것인지도 같이 고려해야한다. 또한 DB에서 병목이 발생했을때 샤딩을 바로 수행하기 보다 캐시를 붙이거나, Read Replica를 사용해 읽기 작업을 처리할 DB을 생성해 DB부하를 줄이거나 , 또는 읽기 전용 DB를 사용해 읽기 작업을 처리한다. 예를 들면 모든 DB를 `Master- Slave`로 만들어 쓰기 무조건 `Master`로 , 읽기 요청은 Slave`로` 가도록한다.

중요한 것은 문제가 발생했을 때 해결하는 것이 아니라, 모니터링 서버에 워닝 포인트를 미리 정해놓고 워닝 포인트를 넘었을 때 미리 확장을 해야 한다.

**그렇다면 어떻게 라이브 확장을 할 수 있을까?**

요청이 들어오면 지금 사용하는 DB와 나중에 사용할 DB에 모두 데이터를 저장한다. 이를 `이중 쓰기(Dual Write)`라고 한다. 따라서 DB 분산을 한 시점 이후에 쓰인 글을 항상 `Dual Read, Dual Write`하고, 과거에 쓴 글을 새로운 DB로 천천히 복사하는 과정을 거쳐서 라이브 확장을 할 수 있다.