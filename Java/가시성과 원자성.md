# **📌 가시성과 원자성**

# 1. 가시성(visibility)

가시성은 다중 쓰레드 환경에서 공유 데이터에 대한 변경 사항이 다른 쓰레드에서 얼마나 빠르게 감지되는지를 나타내는 말이다. 가시성 문제는 주로 캐시와 메모리 모델과 관련이 있다. 다중 쓰레드 환경에서 하나의 쓰레드가 공유 데이터를 수정하면 다른 쓰레드에서 해당 변경 사항을 올바르게 확인할 수 있어야한다.

이 가시성을 보장하기 위해 자바에서는 `synchronized`  키워드, `volatile` 변수, 그리고 `java.util.concurrent` 패키지의 동기화 방법을 사용할 수 있다.

# 2. 원자성(Atomicity)

원자성은 연산이 한번에 실행되거나 전혀 실행되지 않음을 나타낸다. 즉, 작업을 더 이상 나눌수 없다는 의미이다.

자바에서는 `java.util.concurrent.atomic` 패키지에서 제공하는 원자 클래스들이 이러한 원자성을 제공한다. 예를 들어 `AtomicInteger`, `AtomicBoolean`, `AtomicReference` 이 있다.  이 원자성을 사용하면 여러 쓰레드 간에 안전하게 공유변수를 업데이트 할수있다.

또한  `Atomic` 은 `synchronized`를 이용한 동기화보다 성능이 더 빠르다. 예를들어 `Atomic` 클래스의 주요 알고리즘은 `CAS(compare and swap)` 인데 이 알고리즘은 다수의 쓰레드 사이에서 락 경쟁이 발생하지 않으므로 성능이 더 좋다.

예를들어 jvm은 데이터를 `4byte` 단위로 처리한다. 따라서 `int`와 int보다 작은 타입들은 한 번에 읽거나 쓰는 것이 가능하다. 즉 하나의 명령어로 읽거나 쓰기가 가능하다는 말이다 다시말해 더이상 나눌수 없는 최소의 작업단위로 작업 중간에 다른 쓰레드가 끼어들 수 가없다.

그러나 크기가 `8byte`인 `long`과 `double`의 변수는 하나의 명령어로 값을 읽거나 쓸수없어서 변수의 값을 읽은(read)과정에 다른 쓰레드가 끼어들 여지가 있다. 즉 멀티 쓰레드 환경에서 long을 사용하면 원자성 문제가 발생할 수 있다.따라서 `volatile` 키워드를 통해 읽기과 쓰기(write 를 말함 즉 값을 할당하거나 저장함)를 각각 원자화하거나 `java.util.concurrent.atomic` 패키지의 `AtomicLong`를 사용하여 안전하게 다루는 것이 권장된다.

즉 정리하면 가시성은 데이터의 변경 사항이 다른 쓰레드에 얼마나 빨리 보이지는지와 관련이 있고, 원자성은 하나의 연산이 어떻게 실행되는지와 관련이 있다. 그리고 이 두가지 요소는 다중 쓰레드 환경에서 안전한 동시성 프로그래밍을 위해 고려해야하는 부분이다.