# *📌* XSS와 CSRF 특징과 방지 대책

# 1.  XSS (Cross-Site Scripting)

`크로스 사이트 스크립팅`은 `SQL injection`과 함께 가장 웹 상에서 기초적인 취약점 공격 방법의 일종으로 **악의적인 사용자가 공격하려는 사이트에 스크립트를 넣는 기법을 말한다.** 주로 다른 웹사이트와 정보를 교환하는 식으로 작동하므로 사이트 간 스크립팅이라고 한다.

이 취약점은 웹 어플리케이션이 사용자로부터 입력받은 값을 제대로 검사하지않고 사용할 경우 나타나며 공격에 성공하면 사이트에 접속한 사용자는 삽입된 코드를 실행한다. 보통 쿠키나 세션 등의 민감한 정보를 탈취한다.

공격방법에 따라 `Stored XSS`와 `Reflected XSS`로 나뉜다.

- `Stored XSS`는 사이트 게시판이나 댓글, 닉네임 등 스크립트가 서버에 저장되어 실행되는 방식이다.
- `Reflected XSS` 는 URL 파라미터에 스크립트를 넣어 서버에 저장하지 않고 그 즉시 스크립트를 만드는 방식이다.

## 1.1 방지 대책

1. **입력 데이터 검증** : 사용자로부터 받은 입력 데이터를 검증하고 필터링해 허용되지 않는 스크립트가 포함되어있는지 확인한다. 문자열의 형식, 길이를 검증할 수 있다.
2. **이스케이프 처리** : 예를들어 태그의 시작을 의미하는 `<`  문자를 이스케이프 처리하면 `&lt;` 라는 문자로 바꾸는 것을 말한다. 만약에 웹사이트에서 유저가 입력한 데이터를 서버에 이스케이프 처리를 해 db에 저장을 하고,  웹 브라우저가 글을 읽는 요청을하면 서버는 이스케이프 처리한 데이터를 그냥 내려주고 변웹 브라우저는 환을 해서 기호로 되살려준다.
3. **HTTP Only 쿠키 사용** :  `HTTP Only` 쿠키는  자바스크립트에서 접근할 수 없도록 설정하는 방법이다. 따라서  민감한 정보를 담고 있는 쿠키에 설정할 수 있고, 이 쿠키를 생성할때 HttpOnly 속성을 추가함으로써 활성하면된다. 예를들어 사용자가 로그인하면 서버는 사용자의 서버 ID를 생성하고 이를 Http Only 속성이 부여된 쿠키에 저장해 클라이언트에 전달한다. 그리고 이 쿠키는 Http Only속성이 있기때문에 클라이언트에서 확인이 가능하나 조작할 수 없다. 이 쿠키에 담긴 세션 ID를 가지고 클라이언트는 사용자의 로그인상태를 유지하고 관리할 수 있다.
4. **보안 헤더 설정** :  `X-Content-Type-Options`, `X-Frame-Options`, `X-XSS-Protection` 등의 헤더를 설정해 보안을 강화할 수 있다.

# 2. CSRF(Cross-Site Request Forgery attack)

`사이트 간 요청 위조`는 웹 사이트 취약점 공격의 하나로 **사용자가 자신의 의지와는 무관하게 공격자가 의도한 행위(수정, 삭제,등록)을 특정 웹 사이트에 요청하게 하는 공격을 말한다.**

이때 다음과 같은 조건을 만족해야한다.

1. 희생자가 공격자가 만든 피싱 사이트에 접속해야한다.
2. 희생자가 위조 요청을 보낼 사이트에 로그인 되어있어야한다.

방법은 다음과 같다.

![csrf](https://github.com/princenim/TIL/assets/59499600/c2cd27db-66ac-4191-b432-3205b33754c7)


1. 희생자가 위조 요청을 보낼 사이트에 로그인 되어있는 상태로 공격자가 만든 피싱 사이트에 접속한다.
2. 희생자가 피싱 사이트에 접속하면 피싱 사이트에서 위조된 요청을 전송한다. 이때 권한이 있는 브라우저가 갖고있는 세션이나 쿠키를 사용해서 요청을 전송한다.
3. 위조 요청을 받은 사이트는 해당 요청에 대한 응답을 하게 되고 이로 인해 희생자가 의도하지 않은 행동이 실행된다.

`CSRF`는 특정 웹 사이트가 사용자의 웹 브라우저를 신용하는 상태를 노린것이다. 사용자가 웹 사이트에 로그인한 상태에서 사이트간 요청 위조코드가 삽입된 페이지를 열면 공격대상이 되는 웹 사이트는 위조된 공격 명령이 믿을 수 있는 사용자로부터 발송된 것으로 판단해 공격해 노출된다.

그리고 브라우저의 세션과 쿠키를 이용해 위조된 명령을 요청한다는 것은은 세션과 쿠키를 탈취하는 개념과 다르게 봐야한다. 세션이나 쿠키를 탈취한다는 것은 탈취해 얻은 정보를 가지고 공격을 시도하는것이고 CSRF는 이미 인증된 사용자의 브라우저를 통해 공격을 시도하는 것이다.

## 2.2 방지 대책

1. **CSRF 토큰 사용**: 모든 중요한 요청에는 서버에서 생성한 `CSRF 토큰`을 포함시켜야한다. 따라서 사용자는 웹 페이지에 폼을 제출할때마다 이를 제출해야하며 서버는 이를 확인하고 유효하지 않으면 요청을 거부한다. 예를 들어 비밀번호 변경 URL을 호출하려고할때 해당 URL을 호출을 하기 위한 페이지(ui)가 존재한다. 따라서 서버에서 페이지(ui)를 내려줄때  `CSRF 토큰`을 같이 내려주고, 클라이언트에서 비밀번호 변경 요청 API를 호출할때 그 `CSRF 토큰`을 포함시켜서 서버에게 보내야 서버측에서는 요청이 올바르다고 판단하여 안전하게 요청을 수행할 수 있다.  결국은 비밀번호 변경은 무조건 변경 UI를 거쳐서 와야 비밀번호가 변경된다. `Spring Security`는 기본적으로 `CSRF 토큰`  옵션을 제공한다.
2. **Referrer 검증** : 서버에서는 요청의 `Referrer` 헤더를 검증해 요청이 자신의 도메인에서 온 것인지 확인할 수 있다. 레퍼럴은 기본적으로 현재 페이지의 이전페이지를 나타낸다. 현재 페이지를 어떻게 타고 왔는지를 표현하는게 레퍼럴인것이다. 위의 예시처럼 비밀번호 변경 API가 요청되면 HTTP 헤더의 referrer을 확인하는것이다. 이전 페이지의 url주소가 맞는지 확인하고 맞다면 비밀번호를 변경하는 과정을 진행한다.  하지만 `Referrer` 헤더는 항상 신뢰할 수 없으므로 단독으로 사용하기 보다 다른 방법과 사용하는 것이 좋다.

# 3. XSS와 CSRF의 차이

`XSS`와 `CSRF`는 웹 어플리케이션에서 발생하는 보안 취약점을 이용한 공격방법이다.

하지만 `XSS`는 인증된 세션 없이도 공격을 진행할 수 있고, `CSRF`는 사용자의 인증된 세션을 사용하여 공격을 한다. 그리고 `XSS`는 사용자가 특정 사이트를 신뢰한다는 사실을 이용한 공격방식이지만, `CSRF`는 웹 어플리케이션이 인증된 사용자의 요청을 신뢰한다는 사실을 이용한 공격방식이다.